name: PlatformIO Secret Config Generator

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  generate_config:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: 1. Extract PlatformIO data_dir
        id: get-config # 이 스텝의 ID를 'get-config'로 지정합니다.
        run: |
          # platformio.ini 파일에서 'data_dir' 라인을 찾고, '='를 기준으로 분리하여 값($2)만 추출합니다.
          # sed 명령을 사용하여 값의 양 끝 공백과 따옴표를 모두 제거합니다.
          DATA_DIR_PATH=$(grep '^data_dir' platformio.ini | awk -F '=' '{print $2}' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed 's/"//g')
          
          echo "## Extracted data_dir: $DATA_DIR_PATH"
          
          # 이 값을 다음 스텝에서 사용할 수 있도록 GitHub Actions 출력 변수로 설정합니다.
          echo "data_dir_path=$DATA_DIR_PATH" >> $GITHUB_OUTPUT

      - name: 2. Create Config_secret.json in Dynamic Path
        # Secret 값을 환경 변수로 할당합니다.
        env:
          FIREBASE_KEY: ${{ secrets.FIREBASE_API_KEY }}
          GEMINI_KEY: ${{ secrets.GEMINI_API_KEY }}
          # 이전 스텝(get-config)의 출력 변수를 가져와 DATA_DIR에 할당합니다.
          DATA_DIR: ${{ steps.get-config.outputs.data_dir_path }}
          SUB_FOLDER: json_secret # data_dir 아래에 추가할 폴더
          CONFIG_FILE: config_secret.json
          
        run: |
          # 최종 Secret 파일이 위치할 전체 경로를 구성합니다.
          TARGET_DIR="$DATA_DIR/$SUB_FOLDER"
          CONFIG_PATH="$TARGET_DIR/$CONFIG_FILE"
          
          echo "## Creating target directory: $TARGET_DIR"
          mkdir -p $TARGET_DIR
          
          echo "## Generating secret JSON file at: $CONFIG_PATH"
          
          JSON_CONTENT=$(cat <<EOF
{
"FIREBASE_API_KEY": "$FIREBASE_KEY",
"GEMINI_API_KEY": "$GEMINI_KEY" 
}
EOF
          )
          
          # 구성된 JSON 문자열을 최종 경로에 파일로 저장합니다.
          echo "$JSON_CONTENT" > "$CONFIG_PATH"
          
          # 생성된 파일 내용 확인
          echo "--- Content of $CONFIG_PATH ---"
          cat "$CONFIG_PATH"
          echo "-------------------------------------"
          
      # 3. PlatformIO 빌드 스텝 (예시)
      - name: Run PlatformIO Build (Example)
        # ... PlatformIO 설치 및 pio run 명령어 실행 ...
        run: echo "Build process would start here, using the generated $CONFIG_PATH"

