# .github/workflows/ci_005.yml

name: PR

on:
  pull_request:
    branches: [main, main-standalone]
    # 소스 코드와 직접적인 관련이 없는 파일 수정 시 빌드를 건너뜁니다.
    paths:
      - 'platformio.ini'
      - 'lib/**'
      - 'include/**'
      - '.github/workflows/*.yml'
      - 'src/**/*.c'
      - 'src/**/*.cpp'
      - 'src/**/*.h'
      - 'src/**/*.ino'
      - '!**.md'               # 모든 경로의 md 파일 제외
      - '!src/**/data_*/**'    # 웹 소스 폴더 제외 (데이터 변경 시 빌드 불필요)
      - '!src/*_backup/**'     # 백업 폴더 제외 (문법 오류 수정 완료)

jobs:
  # 1단계: 빌드할 환경 목록(Environments) 동적 추출
  get_environments:
    runs-on: ubuntu-latest
    outputs:
      environments: ${{ steps.read_output.outputs.envs }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: List PlatformIO environments
        id: list_envs
        run: |
          python -c "
          import configparser
          import json
          import os
          config = configparser.ConfigParser()
          config.read('platformio.ini')
          
          # 1. 모든 env: 섹션 추출
          all_envs = [s.split(':', 1)[1] for s in config.sections() if s.startswith('env:')]
          
          # 2. 특정 환경만 빌드하도록 필터링 (필요 시 주석 해제하여 조정 가능)
          envs = [e for e in all_envs if e in ['esp32-s3-n16r8']]
          
          # 3. 필터링 결과가 비어있다면 default_envs 시도
          if not envs and 'platformio' in config:
              default = config['platformio'].get('default_envs', '')
              if default: envs = [e.strip() for e in default.split(',')]
          
          # 만약 여전히 비어있다면 전체 환경 사용
          if not envs: envs = all_envs

          print(json.dumps(envs))
          " > envs.json
        shell: bash

      - name: Read environments to output
        id: read_output
        run: |
          ENVS=$(<envs.json)
          if [ "$ENVS" == "[]" ] || [ -z "$ENVS" ]; then
            echo "Error: No environments found to build!"
            exit 1
          fi
          echo "envs=${ENVS}" >> $GITHUB_OUTPUT
        shell: bash

  # 2단계: 추출된 환경별 병렬 빌드 실행
  build:
    runs-on: ubuntu-latest
    needs: get_environments
    strategy:
      fail-fast: false
      matrix:
        environments: ${{ fromJson(needs.get_environments.outputs.environments) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          # cache: 'pip'  # 경고 발생 방지를 위해 제거하고 아래 통합 캐시에서 관리

      # 통합 캐시 설정: pip 패키지 + PIO 코어 + 빌드 결과물
      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.platformio
            .pio
          key: ${{ runner.os }}-pio-${{ matrix.environments }}-${{ hashFiles('**/platformio.ini') }}
          restore-keys: |
            ${{ runner.os }}-pio-${{ matrix.environments }}-
            ${{ runner.os }}-pio-

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade platformio

      - name: Run PlatformIO build for ${{ matrix.environments }}
        run: pio run -e ${{ matrix.environments }}

      - name: Build filesystem image
        run: pio run -e ${{ matrix.environments }} --target buildfs
        continue-on-error: true

      - name: Upload Unified Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.environments }}-build-bundle
          path: |
            .pio/build/${{ matrix.environments }}/firmware.bin
            .pio/build/${{ matrix.environments }}/partitions.bin
            .pio/build/${{ matrix.environments }}/bootloader.bin
            .pio/build/${{ matrix.environments }}/littlefs.bin
          if-no-files-found: warn

