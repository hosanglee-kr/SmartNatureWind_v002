# .github/workflows/ci_005.yml

name: PR

on:
  pull_request:
    branches: [main, main-standalone]
    # 소스 코드와 직접적인 관련이 없는 파일 수정 시 빌드를 건너뜁니다.
    paths:
      - 'platformio.ini'
      - 'lib/**'
      - 'include/**'
      - '.github/workflows/*.yml'
      - 'src/**/*.c'
      - 'src/**/*.cpp'
      - 'src/**/*.h'
      - 'src/**/*.ino'
      - '!**.md'          # 모든 경로의 md 파일 제외
      - '!src/**/data_*/**'    # 웹 소스 폴더 제외 (보통 LittleFS 업로드용이므로 빌드 불필요 시)
      - '!src/*_backup/**
  
jobs:
  get_environments:
    runs-on: ubuntu-latest
    outputs:
      environments: ${{ steps.read_output.outputs.envs }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: List PlatformIO environments
        id: list_envs
        run: |
          python -c "
          import configparser
          import json
          import os
          config = configparser.ConfigParser()
          config.read('platformio.ini')
          
          # 1. 모든 env: 섹션 추출
          # envs = [s.split(':', 1)[1] for s in config.sections() if s.startswith('env:')]
          
          # 2. (선택 사항) 특정 env만 빌드하고 싶을 경우 아래 주석을 해제하고 리스트를 수정하세요.
          envs = [e for e in envs if e in ['esp32-s3-n16r8']]
          # envs = [e for e in envs if e in ['esp32-s3-zero', 'esp32-s3-n16r8']]
          
          # 3. 만약 env가 없다면 default_envs 추출 시도
          if not envs and 'platformio' in config:
              default = config['platformio'].get('default_envs', '')
              if default: envs = [e.strip() for e in default.split(',')]
          
          print(json.dumps(envs))
          " > envs.json
        shell: bash

      - name: Read environments to output
        id: read_output
        run: |
          ENVS=$(<envs.json)
          echo "envs=${ENVS}" >> $GITHUB_OUTPUT
        shell: bash

  build:
    runs-on: ubuntu-latest
    needs: get_environments
    strategy:
      fail-fast: false
      matrix:
        environments: ${{ fromJson(needs.get_environments.outputs.environments) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip' # pip 설치 패키지(platformio 등) 자동 캐싱

      # PlatformIO Core 및 라이브러리/툴체인 통합 캐싱
      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio
            .pio
          # platformio.ini가 변경될 때만 캐시를 새로 생성하여 빌드 속도 극대화
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}-${{ matrix.environments }}
          restore-keys: |
            ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}-
            ${{ runner.os }}-pio-

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade platformio

      - name: Run PlatformIO build for ${{ matrix.environments }}
        run: pio run -e ${{ matrix.environments }}

      - name: Build filesystem image
        run: pio run -e ${{ matrix.environments }} --target buildfs
        continue-on-error: true

      - name: Upload Unified Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.environments }}-build-bundle
          path: |
            .pio/build/${{ matrix.environments }}/firmware.bin
            .pio/build/${{ matrix.environments }}/partitions.bin
            .pio/build/${{ matrix.environments }}/bootloader.bin
            .pio/build/${{ matrix.environments }}/littlefs.bin
          if-no-files-found: warn
